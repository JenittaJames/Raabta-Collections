<%- include('../partials/user/header') %>

<!-- Begin Breadcrumb Area -->
<div class="breadcrumb-area">
  <div class="container">
    <div class="breadcrumb-content">
      <h2>Order Details</h2>
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/orders">My Orders</a></li>
        <li class="active">
          Order #<%= order && order._id ? order._id.toString().substring(0, 8) :
          'N/A' %>
        </li>
      </ul>
    </div>
  </div>
</div>

<!-- Begin Order Details Content Area -->
<main class="page-content">
  <div class="order-details-area">
    <div class="container">
      <div class="order-details-container">
        <!-- Order Summary Section -->
        <div class="order-summary-card">
          <div class="order-summary-header">
            <h3>Order Summary</h3>
            <span class="order-date"
              >Ordered on <%= new Date(order.createdAt).toLocaleDateString()
              %></span
            >
          </div>

          <div class="order-summary-content">
            <div class="detail-row">
              <span class="detail-label">Order ID:</span>
              <span class="detail-value"><%= order._id %></span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Order Status:</span>
              <span
                class="detail-value status-badge <%= order && order.orderStatus ? order.orderStatus.toLowerCase() : '' %>"
              >
                <%= order && order.orderStatus ? order.orderStatus : 'Pending'
                %>
              </span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Payment Method:</span>
              <span class="detail-value"><%= order.paymentMethod %></span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Payment Status:</span>
              <span
                class="detail-value status-badge <%= order.paymentStatus.toLowerCase() %>"
                ><%= order.paymentStatus %></span
              >
            </div>
            <% if (order.shippingDate) { %>
            <div class="detail-row">
              <span class="detail-label">Shipping Date:</span>
              <span class="detail-value"
                ><%= new Date(order.shippingDate).toLocaleDateString() %></span
              >
            </div>
            <% } %> <% if (order.deliveryDate) { %>
            <div class="detail-row">
              <span class="detail-label">Delivery Date:</span>
              <span class="detail-value"
                ><%= new Date(order.deliveryDate).toLocaleDateString() %></span
              >
            </div>
            <% } %>
            <div class="detail-row">
              <span class="detail-label">Total Amount:</span>
              <span class="detail-value price">₹<%= order.orderAmount %></span>
            </div>
          </div>
        </div>

        <!-- Shipping Address Section -->
        <div class="address-section">
          <h3>Shipping Address</h3>
          <% if (address && address.address && address.address.length > 0) { %>
          <div class="address-card">
            <% const addr = address.address[0]; %>
            <div class="address-name"><%= addr.name || '' %></div>
            <p class="address-phone"><%= addr.mobile || '' %></p>
            <p class="address-text">
              <%= [ addr.houseName, addr.street, addr.city, addr.state,
              addr.pincode, addr.country ].filter(Boolean).join(', ') %>
            </p>
            <span class="address-type"><%= addr.saveAs || '' %></span>
          </div>
          <% } else { %>
          <p>No delivery address available</p>
          <% } %>
        </div>

        <!-- Order Items Section -->
        <div class="order-items-section">
          <h3>Ordered Items</h3>
          <div class="order-items-container">
            <% if (order.orderedItem && order.orderedItem.length > 0) { %> <%
            order.orderedItem.forEach(function(item) { %>
            <div class="order-item">
              <div class="item-image">
                <% if (item.productId.productImage &&
                item.productId.productImage.length > 0) { %>
                <img
                  src="/<%= item.productId.productImage[0] %>"
                  alt="<%= item.productId.productName %>"
                />
                <% } else { %>
                <div class="no-image">No Image</div>
                <% } %>
              </div>
              <div class="item-details">
                <h4 class="item-name"><%= item.productId.productName %></h4>
                <% if (item.productId.productDescription) { %>
                <p class="item-description">
                  <%= item.productId.productDescription.substring(0, 100) %>...
                </p>
                <% } %>
                <div class="item-meta">
                  <span class="item-price"
                    >Price: ₹<%= item.productPrice %></span
                  >
                  <span class="item-quantity">Qty: <%= item.quantity %></span>
                </div>
              </div>
              <div class="item-totals">
                <div class="item-total-price">
                  ₹<%= item.totalProductPrice %>
                </div>
                <div
                  class="item-status status-badge <%= item.productStatus.toLowerCase() %>"
                >
                  <%= item.productStatus %>
                </div>
              </div>
            </div>
            <% }); %> <% } else { %>
            <p>No items in this order</p>
            <% } %>
          </div>
        </div>

        <!-- Order Price Summary Section -->
        <div class="price-summary-section">
          <h3>Price Summary</h3>
          <div class="price-summary-content">
            <div class="price-row">
              <span class="price-label">Items Total:</span>
              <span class="price-value"
                >₹<%= order.totalProductAmount || order.orderAmount %></span
              >
            </div>
            <% if (order.shippingCharge) { %>
            <div class="price-row">
              <span class="price-label">Shipping Charge:</span>
              <span class="price-value">₹<%= order.shippingCharge %></span>
            </div>
            <% } %> <% if (order.discount) { %>
            <div class="price-row discount">
              <span class="price-label">Discount:</span>
              <span class="price-value">-₹<%= order.discount %></span>
            </div>
            <% } %> <% if (order.couponDiscount) { %>
            <div class="price-row discount">
              <span class="price-label">Coupon Discount:</span>
              <span class="price-value">-₹<%= order.couponDiscount %></span>
            </div>
            <% } %>
            <div class="price-row total">
              <span class="price-label">Total Amount:</span>
              <span class="price-value">₹<%= order.orderAmount %></span>
            </div>
          </div>
        </div>

        <div class="order-actions-section">
          <a href="/orders" class="btn-back">Back to Orders</a>
          <button id="cancelOrderBtn" data-order-id="<%= order._id %>" class="cancel-order-btn">Cancel Order</button>
          <a href="#" class="btn-contact">Contact Support</a>
        </div>
      </div>
    </div>
  </div>
</main>

<style>
  /* Order Details Page Styles */
  .order-details-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px 0;
  }

  /* Order Summary Card */
  .order-summary-card,
  .address-section,
  .order-items-section,
  .price-summary-section {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;
    padding: 20px;
  }

  .order-summary-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
  }

  .order-summary-header h3,
  .address-section h3,
  .order-items-section h3,
  .price-summary-section h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #333;
  }

  .order-date {
    font-size: 14px;
    color: #666;
  }

  .detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px dashed #eee;
  }

  .detail-row:last-child {
    border-bottom: none;
  }

  .detail-label {
    font-weight: 500;
    color: #666;
  }

  .detail-value {
    font-weight: 500;
    color: #333;
  }

  .detail-value.price {
    font-weight: 600;
    color: #2e7d32;
  }

  /* Status Badge Styles */
  .status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.9em;
    font-weight: 500;
  }

  .status-badge.pending {
    background-color: #fff3e0;
    color: #e65100;
  }

  .status-badge.confirmed {
    background-color: #e3f2fd;
    color: #1976d2;
  }

  .status-badge.shipped {
    background-color: #e8f5e9;
    color: #00796b;
  }

  .status-badge.delivered {
    background-color: #e8f5e9;
    color: #2e7d32;
  }

  .status-badge.cancelled {
    background-color: #ffebee;
    color: #c62828;
  }

  .status-badge.completed {
    background-color: #e8f5e9;
    color: #2e7d32;
  }

  .status-badge.failed {
    background-color: #ffebee;
    color: #c62828;
  }

  /* Address Card Styles */
  .address-card {
    padding: 15px;
    border: 1px solid #eee;
    border-radius: 4px;
    margin-top: 10px;
  }

  .address-name {
    font-weight: 600;
    margin-bottom: 5px;
  }

  .address-line {
    margin-bottom: 3px;
    color: #555;
  }

  .address-phone {
    margin-top: 5px;
    color: #555;
  }

  /* Order Items Styles */
  .order-items-container {
    margin-top: 15px;
  }

  .order-item {
    display: flex;
    padding: 15px 0;
    border-bottom: 1px solid #eee;
  }

  .order-item:last-child {
    border-bottom: none;
  }

  .item-image {
    width: 80px;
    height: 80px;
    min-width: 80px;
    margin-right: 15px;
    border-radius: 4px;
    overflow: hidden;
    border: 1px solid #eee;
  }

  .item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .no-image {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f5f5f5;
    color: #aaa;
    font-size: 12px;
  }

  .item-details {
    flex: 1;
  }

  .item-name {
    margin: 0 0 5px 0;
    font-size: 16px;
    font-weight: 500;
  }

  .item-description {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: #666;
  }

  .item-meta {
    display: flex;
    gap: 15px;
    font-size: 14px;
    color: #555;
  }

  .item-totals {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    justify-content: center;
    padding-left: 15px;
    min-width: 120px;
  }

  .item-total-price {
    font-weight: 600;
    font-size: 16px;
    margin-bottom: 8px;
  }

  /* Price Summary Styles */
  .price-summary-content {
    margin-top: 15px;
  }

  .price-row {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px dashed #eee;
  }

  .price-row:last-child {
    border-bottom: none;
  }

  .price-row.discount .price-value {
    color: #e53935;
  }

  .price-row.total {
    font-weight: 600;
    font-size: 18px;
    border-top: 2px solid #eee;
    margin-top: 10px;
    padding-top: 15px;
  }

  /* Actions Section Styles */
  .order-actions-section {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 10px;
  }

  .btn-back,
  .btn-cancel,
  .btn-contact {
    display: inline-block;
    padding: 10px 20px;
    border-radius: 4px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s;
  }

  .btn-back {
    background-color: #f5f5f5;
    color: #333;
    border: 1px solid #ddd;
  }

  .btn-back:hover {
    background-color: #eee;
  }

  .btn-cancel {
    background-color: #ffebee;
    color: #c62828;
    border: 1px solid #ffcdd2;
  }

  .btn-cancel:hover {
    background-color: #ffcdd2;
  }

  .btn-contact {
    background-color: #333;
    color: #fff;
  }

  .btn-contact:hover {
    background-color: #000;
  }

  /* Responsive Styles */
  @media (max-width: 768px) {
    .order-item {
      flex-direction: column;
    }

    .item-image {
      margin-bottom: 15px;
    }

    .item-totals {
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      padding-left: 0;
      margin-top: 15px;
      width: 100%;
    }

    .item-total-price {
      margin-bottom: 0;
    }

    .order-actions-section {
      flex-direction: column;
    }

    .btn-back,
    .btn-cancel,
    .btn-contact {
      width: 100%;
      text-align: center;
    }
  }
</style>

<%- include('../partials/user/footer') %>


<script>
  document.addEventListener('DOMContentLoaded', function() {
    const cancelButtons = document.querySelectorAll('.cancel-order-btn');
    
    cancelButtons.forEach(button => {
      button.addEventListener('click', function() {
        const orderId = this.getAttribute('data-order-id');
        
        // Show SweetAlert confirmation
        Swal.fire({
          title: 'Cancel Order?',
          text: 'Are you sure you want to cancel this order?',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#3085d6',
          confirmButtonText: 'Yes, cancel it!'
        }).then((result) => {
          if (result.isConfirmed) {
            // User confirmed, send request to server
            cancelOrder(orderId);
          }
        });
      });
    });
    
    function cancelOrder(orderId) {
      fetch(`/orders/${orderId}/cancel`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Show success message
          Swal.fire(
            'Cancelled!',
            'Your order has been cancelled.',
            'success'
          ).then(() => {
            // Redirect or reload page
            window.location.href = '/orders';
          });
        } else {
          // Show error message
          Swal.fire(
            'Error!',
            data.message || 'Failed to cancel order',
            'error'
          );
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire(
          'Error!',
          'Something went wrong',
          'error'
        );
      });
    }
  });
</script>