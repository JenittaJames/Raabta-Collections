<%- include('../partials/admin/header') %>

<div class="container mt-4">
    <div class="row mb-3">
        <div class="col-12">
            <a href="/admin/orders" class="btn btn-secondary">← Back to Orders</a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Order #<%= order._id.toString().slice(-6).toUpperCase() %></h4>
                    <span class="badge bg-<%= order.orderStatus === 'Delivered' ? 'success' : order.orderStatus === 'Cancelled' ? 'danger' : 'warning' %>">
                        <%= order.orderStatus %>
                    </span>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h5>Order Details</h5>
                            <p><strong>Order Date:</strong> <%= new Date(order.createdAt).toLocaleString() %></p>
                            <p><strong>Payment Method:</strong> <%= order.paymentMethod %></p>
                            <p><strong>Payment Status:</strong> <%= order.paymentStatus %></p>
                        </div>
                        <div class="col-md-6">
                            <h5>Customer Details</h5>
                            <p><strong>Name:</strong> <%= order.userId.userName || order.userId.name || 'N/A' %></p>
                            <p><strong>Email:</strong> <%= order.userId.email || 'N/A' %></p>
                            <p><strong>Phone:</strong> <%= order.userId.phone || 'N/A' %></p>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5>Shipping Address</h5>
                            <% if (address && address.address && address.address.length > 0) { %>
                                <div class="address-card">
                                  <% const addr = address.address[0]; %>
                                  <div class="address-name"><%= addr.name || '' %></div>
                                  <p class="address-phone"><%= addr.mobile || '' %></p>
                                  <p class="address-text">
                                    <%= [ addr.houseName, addr.street, addr.city, addr.state,
                                    addr.pincode, addr.country ].filter(Boolean).join(', ') %>
                                  </p>
                                  <span class="address-type"><%= addr.saveAs || '' %></span>
                                </div>
                                <% } else { %>
                                <p>No delivery address available</p>
                                <% } %>
                        </div>
                    </div>

                    <h5>Order Items</h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Status</th>
                                    <th>Total</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% order.orderedItem.forEach(item => { %>
                                    <tr data-product-id="<%= item._id %>">
                                        <td>
                                            <% if (item.productId) { %>
                                                <%= item.productId.productName %>
                                            <% } else { %>
                                                Product Unavailable
                                            <% } %>
                                        </td>
                                        <td>₹<%= item.productPrice.toFixed(2) %></td>
                                        <td><%= item.quantity %></td>
                                        <td>
                                            <select class="form-select product-status-dropdown" data-order-id="<%= order._id %>" data-product-id="<%= item._id %>">
                                                <option value="Pending" <%= item.productStatus === 'Pending' ? 'selected' : '' %>>Pending</option>
                                                <option value="Shipped" <%= item.productStatus === 'Shipped' ? 'selected' : '' %>>Shipped</option>
                                                <option value="Delivered" <%= item.productStatus === 'Delivered' ? 'selected' : '' %>>Delivered</option>
                                                <option value="Cancelled" <%= item.productStatus === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
                                                <option value="Returned" <%= item.productStatus === 'Returned' ? 'selected' : '' %>>Returned</option>
                                            </select>
                                        </td>
                                        <td>₹<%= item.totalProductPrice.toFixed(2) %></td>
                                        <td>
                                            <% if (item.productStatus === 'Return Requested') { %>
                                                <div class="btn-group">
                                                    <button class="btn btn-success btn-sm approve-return" data-product-id="<%= item._id %>">
                                                        Approve Return
                                                    </button>
                                                    <button class="btn btn-danger btn-sm reject-return" data-product-id="<%= item._id %>">
                                                        Reject
                                                    </button>
                                                </div>
                                            <% } %>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="4" class="text-end">Order Total:</th>
                                    <th>₹<%= order.orderAmount.toFixed(2) %></th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Update Order Status</h5>
                </div>
                <div class="card-body">
                    <form id="updateOrderForm">
                        <input type="hidden" name="orderId" value="<%= order._id %>">
                        
                        <div class="mb-3">
                            <label for="orderStatus" class="form-label">Order Status</label>
                            <select class="form-select" id="orderStatus" name="orderStatus">
                                <option value="Pending" <%= order.orderStatus === 'Pending' ? 'selected' : '' %>>Pending</option>
                                <option value="Shipped" <%= order.orderStatus === 'Shipped' ? 'selected' : '' %>>Shipped</option>
                                <option value="Delivered" <%= order.orderStatus === 'Delivered' ? 'selected' : '' %>>Delivered</option>
                                <option value="Cancelled" <%= order.orderStatus === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
                                <option value="Returned" <%= order.orderStatus === 'Returned' ? 'selected' : '' %>>Returned</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="paymentStatus" class="form-label">Payment Status</label>
                            <select class="form-select" id="paymentStatus" name="paymentStatus">
                                <option value="pending" <%= order.paymentStatus === 'pending' ? 'selected' : '' %>>Pending</option>
                                <option value="paid" <%= order.paymentStatus === 'paid' ? 'selected' : '' %>>Paid</option>
                                <option value="failed" <%= order.paymentStatus === 'failed' ? 'selected' : '' %>>Failed</option>
                                <option value="refunded" <%= order.paymentStatus === 'refunded' ? 'selected' : '' %>>Refunded</option>
                                <option value="partially-refunded" <%= order.paymentStatus === 'partially-refunded' ? 'selected' : '' %>>Partially Refunded</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">Update Status</button>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Order Timeline</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>Order Placed</strong>
                                    <p class="mb-0">Status: Created</p>
                                </div>
                                <small><%= new Date(order.createdAt).toLocaleString() %></small>
                            </div>
                        </li>
                        <% if (order.updatedAt && order.updatedAt > order.createdAt) { %>
                            <li class="list-group-item">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <strong>Last Updated</strong>
                                        <p class="mb-0">Status: <%= order.orderStatus %></p>
                                    </div>
                                    <small><%= new Date(order.updatedAt).toLocaleString() %></small>
                                </div>
                            </li>
                        <% } %>

                        <% 
                        // Check for return requests in any order item
                        const returnItems = order.orderedItem.filter(item => 
                            item.productStatus === 'Return Requested' || 
                            item.productStatus === 'Return Approved' || 
                            item.productStatus === 'Return Rejected'
                        );
                        
                        for (const item of returnItems) { 
                        %>
                            <li class="list-group-item">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <strong>Return <%= 
                                            item.productStatus === 'Return Requested' ? 'Requested' : 
                                            item.productStatus === 'Return Approved' ? 'Approved' : 'Rejected' 
                                        %></strong>
                                        <p class="mb-0">
                                            Product: <%= item.productId ? item.productId.productName : 'Product' %>
                                        </p>
                                    </div>
                                    <small><%= new Date(item.updatedAt || order.updatedAt).toLocaleString() %></small>
                                </div>
                            </li>
                        <% } %>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const updateOrderForm = document.getElementById('updateOrderForm');
    
    updateOrderForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const updateData = {
            orderId: formData.get('orderId'),
            orderStatus: formData.get('orderStatus'),
            paymentStatus: formData.get('paymentStatus')
        };
        
        fetch('/admin/orders/update-status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message using SweetAlert
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: 'Order status updated successfully',
                    confirmButtonText: 'OK'
                }).then(() => {
                    // Reload the page to reflect the changes
                    window.location.reload();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Failed',
                    text: 'Failed to update order status: ' + data.message,
                    confirmButtonText: 'OK'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred while updating order status',
                confirmButtonText: 'OK'
            });
        });
    });

    // Handle return approval
    document.querySelectorAll('.approve-return').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            const orderId = '<%= order._id %>';
            
            verifyReturn(orderId, productId, 'Return Approved');
        });
    });

    // Handle return rejection
    document.querySelectorAll('.reject-return').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            const orderId = '<%= order._id %>';
            
            verifyReturn(orderId, productId, 'Return Rejected');
        });
    });

    // Function to verify return request
    function verifyReturn(orderId, productId, status) {
        fetch('/admin/orders/verify-return', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                orderId: orderId,
                productId: productId,
                status: status
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message using SweetAlert
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: data.message,
                    confirmButtonText: 'OK'
                }).then(() => {
                    // Reload the page to reflect the changes
                    window.location.reload();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Failed',
                    text: 'Failed to process return: ' + data.message,
                    confirmButtonText: 'OK'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred while processing the return request',
                confirmButtonText: 'OK'
            });
        });
    }
});


document.addEventListener('DOMContentLoaded', function() {
    // Handle product status updates
    document.querySelectorAll('.product-status-dropdown').forEach(dropdown => {
        dropdown.addEventListener('change', function() {
            const orderId = this.getAttribute('data-order-id');
            const productId = this.getAttribute('data-product-id');
            const productStatus = this.value;

            fetch('/admin/orders/update-product-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    orderId: orderId,
                    productId: productId,
                    productStatus: productStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Product status updated successfully',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        // Reload the page to reflect the changes
                        window.location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Failed',
                        text: 'Failed to update product status: ' + data.message,
                        confirmButtonText: 'OK'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred while updating product status',
                    confirmButtonText: 'OK'
                });
            });
        });
    });
});

</script>

<%- include('../partials/admin/footer') %>