<%- include('../partials/admin/header') %>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1>Orders List</h1>
            <p class="lead">Orders Management</p>
        </div>
    </div>

    <!-- Search Container -->
    <div class="row mb-4">
        <div class="col-12">
            <form action="/admin/orders" method="GET">
                <div class="input-group">
                    <input 
                        type="text" 
                        name="query" 
                        class="form-control" 
                        placeholder="Search by order ID, customer name or status..." 
                        value="<%= locals.searchQuery || '' %>"
                    >
                    <button class="btn btn-dark" type="submit">Search</button>
                    <% if (locals.searchQuery) { %>
                        <a href="/admin/orders" class="btn btn-outline-secondary">Clear</a>
                    <% } %>
                </div>
            </form>
        </div>
    </div>

    <div class="row mt-3">
        <% if (order.length > 0) { %>
            <div class="col-12">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>SL.No</th>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Order Status</th>
                                <th>Payment Status</th>
                                <th>Return Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% order.forEach((order, index) => { %>
                                <tr data-order-id="<%= order.id %>">
                                    <td><%= index + 1 %></td>
                                    <td><%= order.orderNumber %></td>
                                    <td><%= order.userName %></td>
                                    <td><%= new Date(order.orderDate).toLocaleDateString() %></td>
                                    <td>â‚¹<%= order.totalAmount ? order.totalAmount.toFixed(2) : '0.00' %></td>
                                    <td>
                                        <select class="form-select form-select-sm order-status-select" <%= (order.status === 'Cancelled' || order.status === 'Returned') ? 'disabled' : '' %>>
                                            <option value="Pending" <%= order.status === 'Pending' ? 'selected' : '' %> <%= order.status === 'Delivered' ? 'disabled' : '' %>>Pending</option>
                                            <option value="Shipped" <%= order.status === 'Shipped' ? 'selected' : '' %> <%= order.status === 'Delivered' ? 'disabled' : '' %>>Shipped</option>
                                            <option value="Delivered" <%= order.status === 'Delivered' ? 'selected' : '' %> <%= order.status === 'Delivered' ? 'disabled' : '' %>>Delivered</option>
                                            <option value="Cancelled" <%= order.status === 'Cancelled' ? 'selected' : '' %> <%= order.status === 'Delivered' ? 'disabled' : '' %>>Cancelled</option>
                                            <option value="Returned" <%= order.status === 'Returned' ? 'selected' : '' %>>Returned</option>
                                        </select>
                                    </td>
                                    <td>
                                        <select class="form-select form-select-sm payment-status-select" <%= order.paymentStatus === 'failed' ? 'disabled' : '' %>>
                                            <option value="pending" <%= order.paymentStatus === 'pending' ? 'selected' : '' %> <%= (order.paymentStatus === 'paid' || order.paymentStatus === 'refunded' || order.paymentStatus === 'partially-refunded') ? 'disabled' : '' %>>Pending</option>
                                            <option value="paid" <%= order.paymentStatus === 'paid' ? 'selected' : '' %> <%= (order.paymentStatus === 'refunded' || order.paymentStatus === 'partially-refunded') ? 'disabled' : '' %>>Paid</option>
                                            <option value="failed" <%= order.paymentStatus === 'failed' ? 'selected' : '' %> <%= (order.paymentStatus === 'paid' || order.paymentStatus === 'refunded' || order.paymentStatus === 'partially-refunded') ? 'disabled' : '' %>>Failed</option>
                                            <option value="refunded" <%= order.paymentStatus === 'refunded' ? 'selected' : '' %> <%= (order.paymentStatus !== 'paid' && order.paymentStatus !== 'refunded' && order.paymentStatus !== 'partially-refunded') ? 'disabled' : '' %>>Refunded</option>
                                            <option value="partially-refunded" <%= order.paymentStatus === 'partially-refunded' ? 'selected' : '' %> <%= (order.paymentStatus !== 'paid' && order.paymentStatus !== 'refunded' && order.paymentStatus !== 'partially-refunded') ? 'disabled' : '' %>>Partially Refunded</option>
                                        </select>
                                    </td>
                                    <td>
                                        <% if (order.hasReturnRequest) { %>
                                            <span class="badge bg-warning">Return Requested</span>
                                        <% } else if (order.hasReturnApproved) { %>
                                            <span class="badge bg-success">Return Approved</span>
                                        <% } else if (order.hasReturnRejected) { %>
                                            <span class="badge bg-danger">Return Rejected</span>
                                        <% } else { %>
                                            <span class="text-muted">None</span>
                                        <% } %>
                                    </td>
                                    <td>
                                        <a href="/admin/orders/<%= order.id %>" class="btn btn-sm" style="background-color: black; color: white;">
                                            View
                                        </a>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        <% } else { %>
            <div class="col-12">
                <div class="alert alert-info">
                    No Orders found
                </div>
            </div>
        <% } %>
    </div>

    <div class="row mt-3">
        <div class="col-12">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    <% if (currentPage > 1) { %>
                        <li class="page-item">
                            <a class="page-link" href="?page=<%= currentPage - 1 %><%= locals.searchQuery ? '&query=' + searchQuery : '' %>" aria-label="Previous">
                                <span aria-hidden="true">&larr;</span>
                            </a>
                        </li>
                    <% } %>
                
                    <% for (let i = 1; i <= totalPages; i++) { %>
                        <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                            <a class="page-link" href="?page=<%= i %><%= locals.searchQuery ? '&query=' + searchQuery : '' %>"><%= i %></a>
                        </li>
                    <% } %>
                
                    <% if (currentPage < totalPages) { %>
                        <li class="page-item">
                            <a class="page-link" href="?page=<%= currentPage + 1 %><%= locals.searchQuery ? '&query=' + searchQuery : '' %>" aria-label="Next">
                                <span aria-hidden="true">&rarr;</span>
                            </a>
                        </li>
                    <% } %>
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Add JavaScript for AJAX status updates -->
<script>
   document.addEventListener('DOMContentLoaded', function() {
    function updateOrderStatus(orderId, statusType, statusValue) {
        const updateData = {
            orderId: orderId
        };
        
        if (statusType === 'order') {
            updateData.orderStatus = statusValue;
        } else if (statusType === 'payment') {
            updateData.paymentStatus = statusValue;
        }

        // Updated endpoint to match the controller route
        fetch('/admin/orders/update-status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: 'Status updated successfully',
                    confirmButtonText: 'OK'
                }).then(() => {
                    window.location.reload();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Failed!',
                    text: 'Failed to update status: ' + data.message,
                    confirmButtonText: 'OK'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: 'An error occurred while updating status',
                confirmButtonText: 'OK'
            });
        });
    }
    
    document.querySelectorAll('.order-status-select').forEach(select => {
        select.addEventListener('change', function() {
            const orderId = this.closest('tr').dataset.orderId;
            updateOrderStatus(orderId, 'order', this.value);
        });
    });
    
    document.querySelectorAll('.payment-status-select').forEach(select => {
        select.addEventListener('change', function() {
            const orderId = this.closest('tr').dataset.orderId;
            updateOrderStatus(orderId, 'payment', this.value);
        });
    });
});
    </script>
<%- include('../partials/admin/footer') %>