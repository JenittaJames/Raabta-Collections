<%- include('../partials/admin/header') %>

<section class="content-main">
    <div class="content-header">
        <div>
            <h2 class="content-title">Edit Offer</h2>
            <p>Update existing offer details</p>
        </div>
        <button class="back-btn" onclick="window.location.href='/admin/offer'">Back to Offers</button>
    </div>

    <style>
        .back-btn {
            background-color: #000000;
            color: white; 
            font-size: 14px;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .form-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-section {
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #eee;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        
        .form-section-title {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            font-weight: 600;
        }
        
        .submit-btn {
            background-color: #000000;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .radio-input {
            margin-right: 8px;
        }
        
        select[multiple] {
            min-height: 150px;
        }
        
        .hidden {
            display: none;
        }
    </style>

    <div class="form-container">
        <form action="/admin/editoffer/<%= offer._id %>" method="POST" id="offerForm">
            <div class="form-group">
                <label for="offerName">Offer Name</label>
                <input type="text" class="form-control" id="offerName" name="offerName" value="<%= offer.offerName %>" required>
            </div>
            
            <div class="form-group">
                <label for="discount">Discount Percentage (%)</label>
                <input type="number" class="form-control" id="discount" name="discount" min="1" max="100" value="<%= offer.discount %>" required>
            </div>
            
            <div class="form-group">
                <label for="startDate">Start Date</label>
                <input type="datetime-local" class="form-control" id="startDate" name="startDate" value="<%= new Date(offer.startDate).toISOString().slice(0, 16) %>" required>
            </div>
            
            <div class="form-group">
                <label for="endDate">End Date</label>
                <input type="datetime-local" class="form-control" id="endDate" name="endDate" value="<%= new Date(offer.endDate).toISOString().slice(0, 16) %>" required>
            </div>
            
            <div class="form-group">
                <label>Offer Type</label>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="offerType" value="product" class="radio-input" <%= offer.offerType === 'product' ? 'checked' : '' %>> Product Offer
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="offerType" value="category" class="radio-input" <%= offer.offerType === 'category' ? 'checked' : '' %>> Category Offer
                    </label>
                </div>
            </div>
            
            <div id="productSection" class="form-section <%= offer.offerType !== 'product' ? 'hidden' : '' %>">
                <h4 class="form-section-title">Select Products</h4>
                <div class="form-group">
                    <label for="productId">Products</label>
                    <select multiple class="form-control" id="productId" name="productId">
                        <% products.forEach(product => { %>
                            <option value="<%= product._id %>" 
                                <%= offer.productId && offer.productId.some(p => p._id.toString() === product._id.toString()) ? 'selected' : '' %>>
                                <%= product.productName %>
                            </option>
                        <% }) %>
                    </select>
                    <small>Hold Ctrl (or Cmd on Mac) to select multiple products</small>
                </div>
            </div>
            
            <div id="categorySection" class="form-section <%= offer.offerType !== 'category' ? 'hidden' : '' %>">
                <h4 class="form-section-title">Select Categories</h4>
                <div class="form-group">
                    <label for="categoryId">Categories</label>
                    <select multiple class="form-control" id="categoryId" name="categoryId">
                        <% categories.forEach(category => { %>
                            <option value="<%= category._id %>"
                                <%= offer.categoryId && offer.categoryId.some(c => c._id.toString() === category._id.toString()) ? 'selected' : '' %>>
                                <%= category.name %>
                            </option>
                        <% }) %>
                    </select>
                    <small>Hold Ctrl (or Cmd on Mac) to select multiple categories</small>
                </div>
            </div>
            
            <div class="form-group" style="text-align: center; margin-top: 30px;">
                <button type="submit" class="submit-btn">Update Offer</button>
            </div>
        </form>
    </div>
</section>

<%- include('../partials/admin/footer') %>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const offerTypeRadios = document.querySelectorAll('input[name="offerType"]');
        const productSection = document.getElementById('productSection');
        const categorySection = document.getElementById('categorySection');
        
        offerTypeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'product') {
                    productSection.classList.remove('hidden');
                    categorySection.classList.add('hidden');
                } else if (this.value === 'category') {
                    productSection.classList.add('hidden');
                    categorySection.classList.remove('hidden');
                }
            });
        });
        
        const offerForm = document.getElementById('offerForm');
        offerForm.addEventListener('submit', function(event) {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            if (endDate <= startDate) {
                event.preventDefault();
                Swal.fire({
                    title: "Invalid Dates",
                    text: "End date must be after start date",
                    icon: "error",
                    confirmButtonColor: "#000000"
                });
                return false;
            }
            
            const selectedOfferType = document.querySelector('input[name="offerType"]:checked').value;
            
            if (selectedOfferType === 'product') {
                const selectedProducts = document.getElementById('productId').selectedOptions;
                if (selectedProducts.length === 0) {
                    event.preventDefault();
                    Swal.fire({
                        title: "No Products Selected",
                        text: "Please select at least one product for the product offer",
                        icon: "error",
                        confirmButtonColor: "#000000"
                    });
                    return false;
                }
            } else if (selectedOfferType === 'category') {
                const selectedCategories = document.getElementById('categoryId').selectedOptions;
                if (selectedCategories.length === 0) {
                    event.preventDefault();
                    Swal.fire({
                        title: "No Categories Selected",
                        text: "Please select at least one category for the category offer",
                        icon: "error",
                        confirmButtonColor: "#000000"
                    });
                    return false;
                }
            }
        });
    });
</script>